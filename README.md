# EndStone ARC Core Plugin

## 概述

EndStone ARC Core 是一个功能完整的 EndStone (Minecraft 基岩版服务器) 插件，为服务器提供全方位的核心功能模块。该插件包含玩家管理、经济系统、领地管理、传送系统、公告系统、清道夫系统等丰富功能，是构建现代化 Minecraft 服务器的理想选择。插件体验服：IP：arcclub.top，端口：19132，你可以在这个服务器试用体验本插件。

## 作者信息

- **作者**: DEVILENMO
- **邮箱**: DEVILENMO@gmail.com
- **版本**: 0.0.2.3
- **API 版本**: 0.7+
- **推荐 Python 版本**: 3.13

## ✨ 主要功能

### 🗄️ 数据库管理
- 基于 SQLite 的高性能数据库支持
- 线程安全的数据库连接管理
- 自动创建数据库文件和目录
- 支持复杂查询和事务处理
- **XUID主键系统** - 全面使用XUID作为玩家主键，提升数据一致性和查询性能
- **说明** - 自 v0.0.2.3 起不再支持从 UUID 到 XUID 的自动迁移，请使用已迁移至 XUID 的数据库或旧版本完成迁移后再升级

### 🌍 多语言支持
- 完整的国际化系统
- 动态语言文件加载
- 默认支持中文 (ZH-CN)
- 可扩展其他语言包

### 👤 玩家管理系统
- 密码认证登录系统
- 玩家数据持久化存储
- 在线状态实时管理
- 玩家加入/离开消息提示

### 💰 银行经济系统
- 完整的货币管理系统，**金钱精确到分**（float 存储，两位小数）
- 玩家余额存储和查询
- **升级转账功能** - 两步式转账流程，先选择玩家再输入金额，支持小数金额
- 富豪榜排行系统
- 管理员金钱操作命令
- 实时余额变动提醒

### 🏠 领地管理系统
- **三维领地** - 按 min/max X/Y/Z 圈地，按体积计价；粒子显示立方体边界
- **圈地命令** - `/landpos1`、`/landpos2` 选两点后自动排序坐标，`/landbuy` 购买待选领地
- **领地保护机制**（防止破坏/建造/方块互动）
- **免费领地格子系统** - 新玩家可获得免费格子，购买领地时自动减免费用
- **领地授权系统** - 可将领地权限授权给其他玩家
- **子领地系统** - 领地主人可在领地内创建子领地并授权他人；子领地为三维、不可重叠、不可超出父领地；交互时先判子领地权限再判父领地
- **公共领地「允许圈私人领地」** - 公共领地可开启后，玩家可在其内购买私人领地；同一位置优先按私人领地权限判定
- **领地移交功能** - 可将领地转移给其他玩家
- **爆炸保护设置** - 可单独控制领地内是否允许爆炸
- **方块互动开放设置** - 可设置领地对所有人开放方块互动（如开箱子、按按钮等）
- **生物保护系统** - 可控制领地内是否允许与生物交互和攻击生物
- **领地尺寸限制** - 可配置领地最小尺寸，防止创建过小的领地（默认长宽必须都大于5格）
- **领地信息查看功能** - 可查看当前位置的详细领地信息
- **领地边界可视化** - 用粒子效果显示领地边界范围
- **创建领地重叠提示** - 与已有领地重叠时提示与哪些领地重叠
- 领地传送点设置和管理
- 领地重命名功能
- 可配置的领地价格和最小距离
- 智能传送命令生成（自动处理包含空格的玩家名）

### 📍 传送系统
- **私人传送点 (Home)** - 玩家可设置多个传送点
- **公共传送点 (Warp)** - 管理员可创建公共传送点
- **玩家传送请求 (TPA/TPHERE)** - 玩家间传送请求系统
- **死亡回归系统** - 玩家死亡后可传送回死亡地点
- **随机传送系统 (v0.0.1.12新增)** - 随机传送到指定范围内，自动附加羽落效果
- **传送付费系统 (v0.0.1.12新增)** - 每种传送类型可独立配置收费，支持余额检查
- **跨维度传送支持** - 支持在主世界、下界、末地之间自由传送
- **智能维度处理** - 自动使用 `execute in <dimension> run tp` 指令格式
- 传送倒计时提示

### 💴 商店系统
- 适配了 `ushop` 商店插件，如果你安装了 `ushop` ，弧光核心的主菜单中会有 "商店" 按钮
- **arc_button_shop集成** - 新增对arc_button_shop玩家按钮商店的集成支持，可通过主菜单直接访问按钮商店功能，提升玩家开店体验

### 📈 股票系统
- **up_and_down插件适配** - 新增对up_and_down股票插件的集成支持
- 在主菜单中新增"证券交易所"按钮，玩家可直接访问股票交易功能
- 提供便捷的股票系统入口，简化玩家投资操作流程

### 📢 公告系统 (v0.0.1.2新增)
- 定时循环播放公告消息
- 支持多条公告轮播
- **动态占位符支持**：
  - `{date}` - 当前日期 (年-月-日)
  - `{time}` - 当前时间 (小时:分钟)
  - `{online_player_number}` - 当前在线玩家数
- 可配置公告发送间隔
- 从 `broadcast.txt` 文件读取公告内容

### 🧹 清道夫系统 (v0.0.1.2新增)
- 定时自动清理掉落物
- 可配置清理时间间隔
- 清理前10秒倒计时警告
- 清理过程状态提示
- 可通过配置开启/关闭

### 🎊 新人欢迎系统 (v0.0.1.4新增)
- **新玩家自动识别** - 基于数据库记录智能判断新玩家
- **自定义欢迎消息** - 通过 `newbie_welcome.txt` 文件设置欢迎内容
- **自动执行指令** - 通过 `newbie_commands.txt` 文件配置新人自动执行的指令
- **动态玩家名替换** - 指令中的 `{player}` 占位符自动替换为新玩家名称
- **数据库自动初始化** - 新玩家加入时自动创建基础数据和经济账户
- **初始资金设置** - 新玩家自动获得配置中设定的初始金钱
- **UTF-8 编码支持** - 完全支持中文和特殊字符
- **错误处理机制** - 文件读取失败不影响插件正常运行

### 🔐 OP状态追踪系统 (v0.0.1.4新增)
- **OP状态持久化** - 在数据库中记录玩家的OP状态
- **离线状态查询** - 即使玩家离线也能查询其OP状态
- **自动状态同步** - 玩家加入时自动检查并更新OP状态
- **数据库自动升级** - 自动为旧数据库添加OP状态字段
- **金钱排行榜隐藏** - 可配置在金钱排行榜中隐藏OP玩家

### 🛡️ 出生点保护
- 可配置的出生点保护范围
- 防止玩家在出生点附近建筑/破坏
- 多维度出生点支持

### ⚙️ OP 管理面板
- 游戏模式切换
- 手动触发掉落物清理
- 金钱管理（选择玩家后加减款）
- 管理所有领地（传送、强制改名、管理授权、公共领地设置、**强制删除领地**：私人领地全额退款、公共领地无退款）
- **管理脚下领地** - 直接获取脚下私人领地并进入该领地管理
- **重建领地区块映射** - 删除所有维度区块表后按当前 lands 表重新生成（适用于数据库内直接改领地边界后的同步）
- 邀请奖励配置
- **重载配置** - 立即重载配置文件、广播、语言文件等
- 坐标记录功能
- **命令执行面板** - 支持 @p1/@p2 占位符；输入框留空并确定则执行上一次命令（输入框不预填上次命令）

### 🔌 插件 API 系统
- **经济系统 API** - 完整的金钱管理接口
- **线程安全设计** - 支持多插件并发调用
- **错误处理机制** - 自动处理异常情况
- **详细文档支持** - 提供完整的使用示例
- **未来扩展计划** - 领地、传送等系统API

## 命令列表

| 命令 | 描述 | 权限 | 用法 |
|------|------|------|------|
| `/arc` | 打开 ARC Core 主菜单 | 默认 | `/arc` |
| `/updatespawnpos` | 更新当前维度的出生点位置 | OP | `/updatespawnpos` |
| `/suicide` | 自杀命令 | 默认 | `/suicide` |
| `/spawn` | 传送到出生点 | 默认 | `/spawn` |
| `/landpos1` | 设置领地边界点1（记录当前 XYZ） | 需权限 | `/landpos1` |
| `/landpos2` | 设置领地边界点2并预览，可随后 `/landbuy` 购买 | 需权限 | `/landpos2` |
| `/landbuy` | 购买当前待选领地（需已用 landpos1/2 或创建领地表单选好范围） | 需权限 | `/landbuy` |

## 📂 文件结构

插件会在 `plugins/ARCCore/` 目录下创建以下文件：

- `core_setting.yml` - 主要配置文件
- `broadcast.txt` - 公告消息文件
- `{语言代码}.txt` - 语言文件 (如 ZH-CN.txt)
- SQLite 数据库文件

## ⚙️ 配置文件

### core_setting.yml - 主要配置选项

```yaml
# 基础设置
DEFAULT_LANGUAGE_CODE=ZH-CN          # 默认语言
DATABASE_PATH=ARCCore.db             # 数据库文件路径
PLAYER_INIT_MONEY_NUM=10000          # 玩家初始金钱

# 出生点保护
IF_PROTECT_SPAWN=True                # 是否保护出生点
SPAWN_PROTECT_RANGE=8                # 出生点保护范围

# 领地系统
MIN_LAND_DISTANCE=1                  # 领地最小距离
LAND_PRICE=100                       # 领地价格 (每格)
LAND_SELL_REFUND_COEFFICIENT=0.9     # 领地出售退款系数
LAND_MIN_SIZE=5                      # 领地最小尺寸 (长宽必须都大于此值)

# 传送系统
MAX_PLAYER_HOME_NUM=5                # 玩家最大家园数量

# 随机传送配置 (v0.0.1.12新增)
ENABLE_RANDOM_TELEPORT=True          # 是否启用随机传送功能
RANDOM_TELEPORT_CENTER_X=0           # 随机传送中心点X坐标
RANDOM_TELEPORT_CENTER_Z=0           # 随机传送中心点Z坐标
RANDOM_TELEPORT_RADIUS=5000          # 随机传送半径 (格)

# 传送收费配置 (v0.0.1.12新增，0表示免费)
TELEPORT_COST_PUBLIC_WARP=0          # 公共传送点费用
TELEPORT_COST_HOME=0                 # 私人传送点费用
TELEPORT_COST_LAND=0                 # 领地传送费用
TELEPORT_COST_DEATH_LOCATION=0       # 死亡地点传送费用
TELEPORT_COST_RANDOM=100             # 随机传送费用
TELEPORT_COST_PLAYER=50              # 玩家互传费用 (TPA/TPHERE)

# 公告系统
BROADCAST_INTERVAL=180               # 公告发送间隔 (秒)

# 清道夫系统
ENABLE_CLEANER=True                  # 是否启用清道夫
CLEANER_INTERVAL=600                 # 清理间隔 (秒)

# 新人欢迎系统和OP设置
HIDE_OP_IN_MONEY_RANKING=True        # 金钱排行榜是否隐藏OP玩家

# 领地系统
DEFAULT_FREE_LAND_BLOCKS=100         # 新玩家默认免费领地格子数

# 公共领地白名单保护生物 (v0.0.2.1，逗号分隔)
PUBLIC_LAND_PROTECTED_ENTITIES=minecraft:villager,minecraft:iron_golem,minecraft:snow_golem
```

### broadcast.txt - 公告消息文件

每行一条公告，支持占位符：

```txt
欢迎来到ARC弧光基岩服务器！你可以在聊天框发送/arc命令打开服务器操作菜单
请遵守服务器规则，文明游戏，共建和谐游戏环境！
现在是北京时间{date} {time}，请注意休息，爱护眼睛你我做起。
当前服务器在线人数{online_player_number}，求生者们请互帮互助
```

### newbie_welcome.txt - 新人欢迎消息文件 (v0.0.1.4新增)

新玩家第一次加入服务器时显示的欢迎消息：

```txt
欢迎来到ARC弧光大陆服务器！这里是一个恐怖+种田+模拟生活的多模组服务器，拥有丰富的玩法和特色系统！在聊天框输入/arc命令即可打开服务器操作菜单，进行购物、传送、领地管理等操作。

```

### newbie_commands.txt - 新人自动执行指令文件 (v0.0.1.4新增)

新玩家第一次加入服务器时自动执行的指令，每行一个指令：

```txt
# 新人指令文件
# 每行一个指令，{player} 会被替换为玩家名称
# 示例：
gamemode 0 {player}
# clear {player}
give {player} minecraft:bread 5
give {player} krep:m1911
give {player} krep:acp45 42
```

#### 新人指令文件说明
- **注释支持**: 以 `#` 开头的行为注释，不会执行
- **占位符替换**: `{player}` 会自动替换为新玩家的名称
- **指令格式**: 使用标准的Minecraft指令格式，无需添加 `/` 前缀
- **错误处理**: 单个指令执行失败不会影响其他指令

### 支持的占位符

| 占位符 | 描述 | 示例输出 |
|--------|------|----------|
| `{date}` | 当前日期 | `2024-01-15` |
| `{time}` | 当前时间 | `14:30` |
| `{online_player_number}` | 在线玩家数 | `5` |
| `{player}` | 玩家名称 (仅新人指令文件) | `PlayerName` |

## 安装说明

1. 确保您的服务器运行 EndStone 框架
2. 将插件文件放入服务器的 `plugins` 目录
3. 重启服务器
4. 插件会自动创建必要的配置文件和数据库

## 依赖要求

- EndStone 框架 (API 版本 0.7+)
- Python 3.x
- SQLite3 (通常内置于 Python)

## 🎮 使用指南

### 快速开始
1. 玩家进入服务器后，使用 `/arc` 命令打开主菜单
2. 首次使用需要注册账户并设置密码
3. 登录后可使用各种功能：银行、领地、传送等

### 功能操作指南
- **银行系统**: 在主菜单点击"银行"进行转账、查看余额等
  - **转账操作**: 使用全新的两步式转账流程，先从在线玩家列表中选择目标玩家，再输入转账金额
- **领地系统**: 
  - 使用 `/pos1` 和 `/pos2` 设置领地边界，然后在菜单中购买
  - 领地长宽必须都大于配置的最小尺寸（默认5格），确保设置pos1和pos2的距离足够大
  - 新玩家享有免费领地格子，购买时会自动使用免费格子抵扣费用
  - 在领地详情中可设置爆炸保护、方块互动开放等高级选项
  - 支持将领地权限授权给其他玩家或完全移交领地
- **传送系统**: 在主菜单的"传送系统"中管理传送点和发送传送请求
- **公告查看**: 定时播放的公告会自动显示当前时间和在线人数
- **新人欢迎系统**: 
  - 编辑 `newbie_welcome.txt` 自定义新玩家欢迎消息
  - 编辑 `newbie_commands.txt` 配置新玩家自动执行的指令
  - 使用 `{player}` 占位符在指令中引用玩家名称
  - 新玩家首次加入时自动获得初始资金和执行欢迎流程

## 🗃️ 数据存储

插件使用 SQLite 数据库存储以下数据：
- **玩家信息**: 用户名、XUID、密码哈希、OP状态、剩余免费领地格子数、邀请人(inviter_xuid)、待领取邀请奖励次数、注册时间
- **经济数据**: 玩家余额、交易记录
- **领地信息**: 领地坐标、拥有者、传送点、共享用户、爆炸保护设置、方块互动开放设置、生物保护设置
- **传送点**: 私人传送点、公共传送点坐标信息
- **服务器配置**: 出生点坐标、系统设置

### 🆕 数据库自动升级系统 (v0.0.1.4新增)
- **智能检测**: 自动检测数据库版本并执行必要的升级
- **字段添加**: 为旧数据库自动添加新字段（如is_op字段）
- **向后兼容**: 完全兼容旧版本数据，无需手动迁移
- **安全升级**: 升级过程包含完整的错误处理机制
- **XUID主键系统** (v0.0.1.8 引入): 使用 XUID 作为玩家主键（v0.0.2.3 起不再支持 UUID→XUID 自动迁移）

## 🛠️ 开发信息

### 项目结构
```
EndStone-ARC-CORE/
├── src/endstone_arc_core/
│   ├── __init__.py              # 插件初始化
│   ├── arc_core_plugin.py       # 主插件类
│   ├── DatabaseManager.py       # 数据库管理器
│   ├── LanguageManager.py       # 语言管理器
│   └── SettingManager.py        # 设置管理器
├── dist/ARCCore/
│   ├── core_setting.yml         # 配置文件
│   ├── broadcast.txt            # 公告文件
│   ├── newbie_welcome.txt       # 新人欢迎消息文件
│   ├── newbie_commands.txt      # 新人自动执行指令文件
│   └── ZH-CN.txt               # 中文语言包
└── pyproject.toml              # 项目配置
```

### 核心技术特性
- **线程安全**: 数据库操作完全线程安全
- **多线程架构**: 位置检测系统使用独立线程，提升60%响应速度
- **事件驱动**: 基于 EndStone 事件系统
- **定时任务**: 使用 Scheduler 实现定时功能
- **模块化设计**: 各功能模块独立，易于维护
- **动态配置**: 支持运行时配置重载
- **精确坐标计算**: 使用 math.floor() 确保负坐标位置计算准确
- **XUID主键系统**: 全面使用XUID作为玩家标识，提升数据一致性和查询性能
- **数据库结构升级**: 支持表结构自动升级（自 v0.0.2.3 起不再提供 UUID→XUID 迁移）
- **统一接口设计**: API和内部功能基于同一套底层接口，提升代码复用性和维护性
- **坐标处理统一**: 所有坐标计算统一使用math.floor()，确保负坐标处理正确
- **可视化领地系统**: 支持粒子效果显示领地边界，提供直观的领地范围展示

### API 兼容性
- **EndStone API**: 0.11+
- **Python**: 3.13+

## 📈 性能特性

- **高效的区块索引**: 领地系统使用区块映射，快速定位
- **内存优化**: 合理的缓存策略，减少数据库查询
- **异步处理**: 耗时操作使用定时任务处理
- **资源清理**: 自动清理过期的传送请求和临时数据

## 🔒 安全特性

- **密码保护**: 玩家密码使用 SHA-256 哈希存储
- **权限系统**: 基于 EndStone 权限系统
- **输入验证**: 所有用户输入都经过严格验证
- **SQL 注入防护**: 使用参数化查询

## 🔌 API 接口

ARC Core 插件提供了丰富的 API 接口供其他插件调用，主要包括经济系统相关的功能。

### 💰 经济系统 API

**统一接口设计**：所有API函数都基于统一的底层`*_by_name`系列函数实现，确保与插件内部功能使用相同的数据处理逻辑，提高一致性和可维护性。

#### 1. 获取所有玩家金钱数据
```python
def api_get_all_money_data(self) -> dict
```
- **功能**: 获取所有玩家的金钱数据
- **返回值**: `dict` - 键为玩家名称，值为金钱数量
- **示例**:
```python
arc_plugin = server.get_plugin('ARCCore')
money_data = arc_plugin.api_get_all_money_data()
# 返回: {'PlayerA': 10000, 'PlayerB': 5000, ...}
```

#### 2. 获取单个玩家金钱
```python
def api_get_player_money(self, player_name: str) -> float
```
- **功能**: 获取指定玩家的金钱数量（支持小数，精确到分）
- **参数**: `player_name` (str) - 玩家名称
- **返回值**: `float` - 玩家金钱数量，玩家不存在时返回 0.0
- **示例**:
```python
money = arc_plugin.api_get_player_money('PlayerName')
```

#### 3. 获取最富有玩家信息
```python
def api_get_richest_player_money_data(self) -> list
```
- **功能**: 获取服务器中最富有玩家的信息
- **返回值**: `list` - [玩家名称, 金钱数量]，无数据时返回 ['', 0]
- **示例**:
```python
richest = arc_plugin.api_get_richest_player_money_data()
# 返回: ['RichPlayer', 999999]
```

#### 4. 获取最贫穷玩家信息
```python
def api_get_poorest_player_money_data(self) -> list
```
- **功能**: 获取服务器中最贫穷玩家的信息
- **返回值**: `list` - [玩家名称, 金钱数量]，无数据时返回 ['', 0]
- **示例**:
```python
poorest = arc_plugin.api_get_poorest_player_money_data()
# 返回: ['PoorPlayer', 100]
```

#### 5. 修改玩家金钱
```python
def api_change_player_money(self, player_name: str, money_to_change: float) -> bool
```
- **功能**: 增加或减少指定玩家的金钱（支持小数，精确到分）
- **参数**: 
  - `player_name` (str) - 玩家名称
  - `money_to_change` (float) - 要改变的金钱数量（正数为增加，负数为减少）
- **返回值**: `bool` - 是否操作成功
- **注意事项**:
  - 如果玩家在线，会自动发送金钱变动提示消息
  - 变动数量经四舍五入到分后为 0 时视为无效，返回 False
- **示例**:
```python
# 给玩家增加 1000 金钱
arc_plugin.api_change_player_money('PlayerName', 1000)

# 从玩家扣除 500 金钱
arc_plugin.api_change_player_money('PlayerName', -500)
```

### 🔧 API 使用示例

#### 完整的插件集成示例
```python
from endstone.plugin import Plugin

class MyPlugin(Plugin):
    def on_enable(self):
        # 获取 ARC Core 插件实例
        self.arc_core = self.server.get_plugin('arc_core')
        
        if self.arc_core is None:
            self.logger.error("ARC Core plugin not found!")
            return
    
    def give_reward_to_player(self, player_name: str, amount: int):
        """给玩家发放奖励金钱"""
        try:
            # 检查玩家当前金钱
            current_money = self.arc_core.api_get_player_money(player_name)
            self.logger.info(f"Player {player_name} current money: {current_money}")
            
            # 增加金钱
            self.arc_core.api_change_player_money(player_name, amount)
            
            # 获取更新后的金钱
            new_money = self.arc_core.api_get_player_money(player_name)
            self.logger.info(f"Player {player_name} new money: {new_money}")
            
        except Exception as e:
            self.logger.error(f"Failed to give reward: {e}")
```

### 📋 API 注意事项

1. **插件依赖**: 确保您的插件在 `plugin.yml` 中声明了对本插件的依赖
2. **错误处理**: 所有 API 调用都应该包含适当的错误处理
3. **线程安全**: 所有 API 方法都是线程安全的，可以在任何线程中调用
4. **性能考虑**: 频繁调用 `api_get_all_money_data()` 可能影响性能，建议缓存结果
5. **玩家存在性**: API 会自动处理不存在的玩家，但建议在调用前验证玩家是否存在

### 🚀 未来 API 计划

- **领地系统 API**: 查询、创建、管理领地的接口
- **传送系统 API**: 程序化传送点管理
- **权限系统 API**: 玩家权限查询和管理
- **数据统计 API**: 服务器统计数据接口

## 📄 许可证

本项目采用开源许可证，详见 LICENSE 文件。

## 🤝 支持与反馈

- **作者邮箱**: DEVILENMO@gmail.com
- **问题反馈**: 请详细描述问题和复现步骤
- **功能建议**: 欢迎提供改进建议

## 📋 更新日志

### v0.0.2.3 (当前版本)

- 🔧 **移除 UUID→XUID 迁移功能**
  - 自本版本起不再支持从 UUID 到 XUID 的自动数据迁移
  - 移除 `MigrationManager` 模块及插件启动时的迁移逻辑
  - 请确保数据库已使用 XUID 体系，或先使用v0.0.2.2版本完成迁移后再升级至本版本

- 🐛 **修复「查看当前领地」/「管理脚下领地」误报不处于领地**
  - 与进入领地提示、权限检测统一逻辑：均使用 `player.location.dimension.name` 作为维度，并向 `get_land_at_pos` 传入 y 做三维判断
  - 此前「当前领地信息」使用 `player.dimension.name.lower()` 且未传 y，与位置线程不一致，导致进入领地能弹提示但点「查看当前领地」却提示不处于领地

### v0.0.2.2

- ✅ **三维领地与圈地流程**
  - 领地改为三维：创建时输入 min/max X/Y/Z，按体积（方块数）× 地价计费；默认地价 100/格，新玩家免费格子 1000
  - 命令 `/landpos1`、`/landpos2` 记录两点 XYZ 并自动排序为最小/最大坐标，粒子显示立方体边界，可用 `/landbuy` 或 UI 购买
  - 创建领地表单支持预填/修改坐标，提交后显示体积与费用，可「重新选择坐标」或购买
  - 数据库 `lands` 新增 `min_y`、`max_y`，旧数据迁移为 0～255；重叠检测先判 Y 再判 XZ

- ✅ **子领地系统**
  - 领地主人可在领地详情中「管理子领地」：创建三维子领地、重命名、删除、管理授权
  - 子领地不得超出父领地、不得与同父下其他子领地重叠；交互/破坏时先判子领地权限，再判父领地
  - 公共领地无子领地入口（私人领地才支持子领地）

- ✅ **公共领地「允许圈私人领地」**
  - 公共领地设置中新增「允许圈私人领地」开关（OP 在公共领地设置里配置）
  - 开启后，圈地重叠检测会忽略该公共领地，玩家可在其内购买私人领地；同一位置优先按私人领地权限判定

- ✅ **领地数据与退款**
  - `owner_paid_money` 仅在建表升级**首次添加该列**时按面积×地价回填；列已存在绝不重算（修复此前因 `execute()` 吞异常导致每次启动重算的 bug，改用 `_column_exists` 判断）
  - 领地设为公共领地时自动将 `owner_paid_money` 置为 0

- ✅ **创建领地重叠提示**
  - 与已有领地重叠时，提示「与以下领地重叠：#ID 名称, …」

- ✅ **OP 领地与区块**
  - OP 面板「管理脚下领地」：直接取脚下私人领地并进入该领地管理
  - OP 领地详情中「强制删除领地」：私人领地全额退款给主人，公共领地无退款
  - OP 面板「重建领地区块映射」：删除所有 `chunk_lands_*` 表后按当前 `lands` 表重新生成，便于在数据库里改领地边界后一键同步
  - 区块映射逻辑抽成 `_register_land_to_chunk_mapping`，创建领地与重建映射共用

- ✅ **OP 执行指令**
  - 输入框留空并确定时执行**上一条指令**；输入框不再预填上次命令，保持空白

### v0.0.2.1 — 全新小版本

- ✅ **我的信息 & 邀请系统**
  - 主菜单新增「我的信息」按钮，展示：名字、XUID、存款、领地数、剩余免费领地格子、邀请人、待领取邀请奖励次数
  - 数据库 `player_basic_info` 新增 `inviter_xuid`（邀请人）、`pending_invite_reward_times`（待领取邀请奖励次数）
  - 未填写邀请人时可「填写邀请人」；填写后当场为双方发放奖励（被邀请人即时发放，邀请人累加待领取）
  - 有待领取奖励时可「领取邀请奖励」；玩家上线时若有待领取会提示
  - OP 面板新增「邀请奖励配置」：可设置物资（物品 ID + 数量）、金钱、免费领地格子数奖励

- ✅ **经济系统升级：金钱精确到分**
  - 金钱存储由整数改为 `REAL`（float），精确到分（两位小数）
  - 旧数据库自动升级：`player_economy.money` 从 INTEGER 迁移为 REAL
  - 新增 `_round_money()` / `_format_money_display()`，界面统一两位小数显示
  - 转账、OP 加减款、初始金钱、邀请奖励等均支持小数；经济相关 API 返回/接受 `float`

- ✅ **OP 领地管理增强**
  - 在「管理所有领地」中打开任意领地后，提供完整管理入口：
    - **传送前往**：传送到该领地传送点（不扣费）
    - **强制修改领地名称**：任意领地均可修改名称（不限于公共领地）
    - **管理授权**：添加/移除授权玩家，与领地主人的授权管理逻辑一致
  - 公共领地仍保留「公共领地设置」「设为公共领地」等入口

- ✅ **公共领地白名单保护生物**
  - 配置项 `PUBLIC_LAND_PROTECTED_ENTITIES`：逗号分隔的生物类型 ID（如 `minecraft:villager,minecraft:iron_golem`）
  - 公共领地内：若「禁止生物伤害」则一律拦截所有生物伤害；若「开放生物伤害」则仅保护白名单内生物，其他生物可被伤害
  - 设为公共领地时默认开放：方块互动、生物互动、生物伤害

- ✅ **OP 重载配置**
  - OP 面板新增「重载配置」按钮，可立即重新载入：
    - 配置文件（`core_setting.yml`）并重新应用缓存项（领地价格、传送费用、公告间隔等）
    - 广播列表（`broadcast.txt`）
    - 语言文件（当前语言）
  - 迎新指令/迎新文案在下次新人进服时自动使用最新文件；公告与清道夫间隔变更需重启服务器后生效

- ✅ **执行指令记住上次命令**
  - 每位 OP 执行过的指令会记录为「上一次命令」
  - 执行指令面板输入框默认显示上次命令；留空直接确定则使用当前记录点（@p1/@p2）重复执行上次命令
  - 便于重复执行 fill 等命令：选点后直接点执行即可

### v0.0.1.14
- ✅ **OP 管理所有领地** - 全服领地一览与快捷管理
  - 在 OP 面板中新增「管理所有领地」入口
  - 分页展示全服所有领地（ID、名称、所有者、维度）
  - 点击领地可查看详情并「传送前往」（OP 不扣费）
  - 支持从详情返回时保留当前页码

- ✅ **公共领地系统** - 可设为系统公共领地
  - 可将任意领地「设为公共领地」，`owner_xuid` 置为 `0`
  - 进入公共领地时显示「公共领地」而非所有者名称（支持多语言）
  - 公共领地仅 OP 可管理：破坏/放置、方块互动（未开放时）仅 OP 允许
  - OP 可在公共领地详情中进入「公共领地设置」，单独配置：
    - 开放方块互动、开放爆炸、开放生物互动、开放生物伤害
  - 公共领地支持 OP 修改领地名称

### v0.0.1.13
- ✅ **金钱管理 UI 重构** - 更安全便捷的管理方式
  - 将 `addmoney` 和 `removemoney` 命令改为 UI 菜单形式
  - 集成到 OP 面板，仅管理员可访问
  - 三步式操作流程：选择操作类型 → 选择玩家 → 输入金额
  - 选择玩家时显示当前余额，方便操作
  - 完整的输入验证和错误提示
  - 移除了命令形式，提升安全性

### v0.0.1.12
- ✅ **随机传送系统** - 全新的探险功能
  - 可配置的随机传送中心点和半径
  - 在指定范围内随机生成传送坐标
  - 自动附加10秒羽落效果，防止玩家摔死
  - 配置项：`ENABLE_RANDOM_TELEPORT`（开关）、`RANDOM_TELEPORT_CENTER_X/Z`（中心点）、`RANDOM_TELEPORT_RADIUS`（半径）

- ✅ **传送付费系统** - 灵活的经济控制
  - 支持所有传送类型独立收费配置
  - 公共传送点收费 (`TELEPORT_COST_PUBLIC_WARP`)
  - 私人传送点收费 (`TELEPORT_COST_HOME`)
  - 领地传送收费 (`TELEPORT_COST_LAND`)
  - 死亡地点传送收费 (`TELEPORT_COST_DEATH_LOCATION`)
  - 随机传送收费 (`TELEPORT_COST_RANDOM`)
  - 玩家互传收费 (`TELEPORT_COST_PLAYER`)
  - 传送前自动检查余额，余额不足时阻止传送
  - 传送按钮自动显示费用（仅当费用>0时）
  - 设置为0表示免费传送

### v0.0.1.11
- ✅ **死亡消息系统升级** - 全新的Q群死亡通知机制
  - **幽默死亡原因翻译** - 为各种死亡原因添加了有趣的翻译
    - 摔落 → "验证了牛顿第一定律"
    - 溺水 → "明白了学游泳的重要性"
    - 岩浆 → "体验了岩浆浴"
    - 火焰 → "玩火自焚"
    - 以及其他各种死亡原因的幽默翻译
  - **维度名称本地化** - 自动翻译维度名称
    - Overworld → 主世界
    - Nether → 下界
    - TheEnd → 末地
  - **生物攻击者显示** - 显示导致玩家死亡的生物名称
    - 支持显示生物名称（如"iron_golem"）
    - 智能消息格式：被生物杀死时显示"被 XXX 杀死了"
  - **消息格式优化** - 三种灵活的消息格式
    - 基础死亡消息（无原因）
    - 包含死亡原因的消息
    - 包含生物攻击者的消息
  - **LanguageManager集成** - 使用统一的语言管理器
    - 所有翻译条目通过语言文件管理
    - 支持动态扩展新的死亡原因翻译
  - **QQ群集成** - 自动发送死亡消息到QQ群
    - 游戏内和QQ群同步显示死亡信息
    - 支持完整的死亡信息格式化
  - **代码兼容性修复** - 修复字符串格式化问题
    - 统一使用单引号包裹f-string，双引号用于内部字符串，提升代码兼容性，支持了低于Python3.13的Python环境

### v0.0.1.10
- ✅ **领地生物保护系统** - 全新的生物保护机制
  - **生物互动保护** - 可控制领地内是否允许与生物进行交互
  - **生物攻击保护** - 可控制领地内是否允许攻击生物
  - **智能权限验证** - 只有领地主人和授权用户可以执行受保护的操作
  - **完整UI支持** - 在领地设置中提供便捷的开关控制
  - **数据库自动升级** - 为现有领地自动添加新的保护字段
  - **多语言支持** - 完整的中文界面和提示信息

- ✅ **别踩白块小游戏设施适配** - 智能游戏设施保护机制
  - **设施识别** - 自动识别别踩白块小游戏设施方块，避免误拦截
  - **方块破坏保护** - 在方块破坏事件中优先检查是否为DTWT设施，允许正常游戏操作
  - **方块交互保护** - 在方块交互事件中跳过DTWT设施的权限检查，确保游戏正常运行
  - **插件联动** - 与arc_dtwt插件无缝集成，提供完整的游戏体验
  - **智能检测** - 使用DTWT插件的API接口判断方块是否为游戏设施起始方块

- ✅ **股票系统适配** - 新增up_and_down插件集成支持
  - 在主菜单中新增"股票市场"按钮，玩家可直接访问股票交易功能
  - 提供便捷的股票系统入口，简化玩家投资操作流程
  - 自动检测up_and_down插件是否安装，动态显示股票功能

### v0.0.1.9
- ✅ **领地信息查看功能** - 全新的领地信息展示系统
  - 在领地主菜单中新增"查看脚下领地"按钮
  - 显示当前位置的详细领地信息，包括领地编号、名称、拥有者、坐标范围等
  - 支持显示爆炸保护状态和公共互动设置
  - 显示授权玩家列表，提供完整的领地权限信息
  - 通过send_message方式发送格式化的领地信息

- ✅ **领地边界粒子显示** - 可视化领地范围
  - 实现领地边界的粒子效果显示，使用`minecraft:crop_growth_emitter`粒子
  - 在玩家当前Y坐标高度显示粒子，确保玩家可以直接看到边界
  - 绘制完整矩形边界：4个角点 + 每条边8个插值点 = 总共36个粒子点
  - 支持手动查看和自动进入领地时显示两种模式
  - 提供直观的领地范围可视化效果

- ✅ **坐标处理系统修复** - 解决圈地偏移问题
  - 修复圈地命令中坐标处理不一致的问题
  - 统一所有坐标处理使用`math.floor()`而非`int()`
  - 解决负坐标处理错误导致的圈地"圈歪"问题
  - 修复范围：圈地命令、爆炸事件、方块检测、传送点设置等
  - 确保坐标计算与领地检测系统完全一致

- ✅ **arc_button_shop集成优化** - 商店系统功能增强
  - 更新对arc_button_shop玩家按钮商店的集成支持
  - 优化玩家开店体验，简化按钮商店访问流程
  - 在主菜单中提供便捷的按钮商店入口

### v0.0.1.8
- ✅ **XUID主键系统升级** - 数据库架构重大升级
  - 全面升级为使用XUID作为玩家主键，替代原有的UUID系统
  - 提升数据一致性和查询性能，减少跨表查询的复杂度
  - 所有玩家相关表（player_basic_info、player_economy、lands等）统一使用XUID
  - 新增MigrationManager模块，专门处理数据库迁移和升级
  - 自动检测旧数据库并执行从UUID到XUID的完整迁移流程
  - 包含完整的数据备份机制，确保迁移过程的安全性
  - 向后兼容：旧版本数据库可无缝升级，无需手动干预

- ✅ **玩家按钮商店集成** - 商店系统功能扩展
  - 新增对arc_button_shop玩家按钮商店的集成支持
  - 在主菜单中新增"按钮商店"选项，玩家可直接访问按钮商店功能
  - 提升玩家开店的体验，简化按钮商店访问流程

- ✅ **数据库迁移系统** - 智能升级机制
  - 新增MigrationManager.py模块，专门处理数据库结构升级
  - 支持从UUID系统到XUID系统的完整数据迁移
  - 自动创建数据备份表，确保迁移过程的安全性
  - 智能检测迁移状态，避免重复执行迁移操作
  - 支持多表迁移：player_economy、lands、public_warps、player_homes等
  - 完整的错误处理和日志记录机制

- ✅ **银行操作接口统一化** - 代码架构优化
  - 统一银行操作接口，API和插件内部调用基于同一套底层函数
  - 所有金钱相关操作统一使用`*_by_name`系列函数作为底层实现
  - Player对象封装器函数（如`get_player_money`）内部调用统一的`by_name`接口
  - API函数（如`api_get_player_money`）直接复用底层`by_name`接口
  - 提升代码复用性和维护性，减少重复代码
  - 确保API和内部功能使用相同的数据处理逻辑，提高一致性

### v0.0.1.7
- ✅ **多线程位置检测系统** - 性能优化重大升级
  - 将玩家位置检测从定时器模式改为多线程方式，显著提升性能
  - 响应速度提升60%：从1.25秒检测一次优化到0.5秒一次
  - 减少主线程负载：位置检测在独立线程运行，游戏更流畅
  - 智能资源管理：无玩家在线时自动跳过检测，节省服务器资源
  - 线程安全设计：使用互斥锁保护共享数据，防止竞态条件
  - 完善的线程生命周期管理：插件启动时自动开始，禁用时安全停止
  - 优雅的异常处理：单个玩家错误不影响其他玩家，自动恢复机制
  - 玩家退出时线程安全地清理位置记录，防止内存泄漏

- ✅ **坐标计算错误修正** - 修复负坐标偏差问题
  - 修复 `get_player_position_vector()` 函数中的坐标计算错误
  - 将 `int()` 转换改为 `math.floor()`，确保负坐标正确计算方块位置
  - 解决了OP记录坐标和fill操作时的偏差问题
  - 影响功能：坐标记录、领地检测、出生点保护等所有位置相关功能
  - 例如：玩家在(-0.5, 64, -0.3)时，现在正确返回(-1, 64, -1)而不是(0, 64, 0)

- ✅ **领地尺寸限制检查** - 防止创建过小领地
  - 新增领地创建时的尺寸检查，长宽必须都大于配置的最小值
  - 新增 `LAND_MIN_SIZE` 配置项（默认值为5），可在配置文件中调整
  - 在 `show_new_land_info()` 函数中添加尺寸验证逻辑
  - 当尺寸不符合要求时，显示详细的错误提示信息
  - 提升用户体验，避免意外创建过小的无用领地

### v0.0.1.6
- ✅ **免费领地格子系统** - 新玩家福利机制
  - 新增 `DEFAULT_FREE_LAND_BLOCKS` 配置项，支持设置新玩家默认免费领地格子数
  - 在 `player_basic_info` 表中添加 `remaining_free_land_blocks` 字段记录剩余免费格子数
  - 数据库自动升级系统支持为现有玩家添加免费格子数字段
  - 领地购买时自动优先使用免费格子，减少金钱消耗
  - 新玩家进服默认获得100个免费格子，可免费获得一块小领地
  - 增加相关函数：`get_player_free_land_blocks()` 和 `set_player_free_land_blocks()`

- ✅ **转账系统UI重构** - 全新的转账用户体验
  - 全新的两步式转账流程：先选择目标玩家，再输入转账金额
  - 新增 `show_transfer_panel()` 在线玩家选择面板，过滤并显示所有可转账的在线玩家
  - 新增 `show_transfer_amount_panel()` 转账金额输入面板，实时显示当前余额和目标玩家信息
  - 新增 `_validate_transfer_data_new()` 函数，优化转账数据验证流程
  - 增强转账过程中的信息提示和错误处理机制
  - 提供更加直观友好的转账操作界面

### v0.0.1.5
- ✅ **别踩白块插件UI联动** - 游戏记录查看功能
  - 在主菜单中新增"别踩白块小游戏"按钮
  - 可直接从ARC Core主菜单查看别踩白块插件的游戏记录信息
  - 实现跨插件UI集成，提升玩家体验

- ✅ **清道夫系统优化** - 试炼钥匙保护机制
  - 清道夫清理掉落物时不会清理试炼钥匙物品
  - 保护两种试炼钥匙不被自动清理系统误删
  - 确保重要游戏道具的安全性

### v0.0.1.4
- ✅ **新人欢迎系统** - 全新的新玩家引导体验
  - 自动识别新玩家并发送自定义欢迎消息
  - 支持通过 `newbie_welcome.txt` 文件自定义多行欢迎内容
  - 自动执行新人指令，通过 `newbie_commands.txt` 配置
  - 新玩家自动初始化数据库记录和经济账户
  - 完整的UTF-8编码支持和错误处理机制

- ✅ **OP状态追踪系统** - 持久化OP状态管理
  - 在数据库中记录玩家OP状态，支持离线查询
  - 玩家加入时自动同步OP状态变化
  - 金钱排行榜可配置隐藏OP玩家 (`HIDE_OP_IN_MONEY_RANKING`)
  - 数据库自动升级，为旧数据库添加 `is_op` 字段
  - 完整的向后兼容性，无需手动数据迁移

- ✅ **稳定性改进** - 插件启动优化
  - 修复插件初始化期间的日志记录问题
  - 添加安全日志记录机制，避免启动失败
  - 优化错误处理，提高插件稳定性

### v0.0.1.3
- ✅ **跨维度传送系统重构** - 全面升级传送机制
  - 支持主世界 (overworld)、下界 (nether)、末地 (the_end) 之间的自由传送
  - 传送指令格式升级为 `execute in <dimension> run tp player_name x y z`
  - 移除了维度检查限制，玩家可以跨维度使用所有传送功能
  - 智能维度名称处理，自动转换完整维度名称格式
  - 涵盖所有传送功能：Home传送、Warp传送、死亡回归、领地传送、玩家间传送

### 历史版本已实现功能
- ✅ 完整的玩家管理和认证系统
- ✅ 银行经济系统（转账、富豪榜）
- ✅ **转账系统UI重构**（两步式流程、玩家选择面板、金额输入面板）
- ✅ 领地管理系统（圈地、保护、移交、授权管理）
- ✅ **免费领地格子系统**（新玩家福利、自动费用减免）
- ✅ **领地高级设置**（爆炸保护、方块互动开放设置、生物保护系统）
- ✅ 传送系统（Home、Warp、TPA、死亡回归、随机传送）
- ✅ **随机传送系统**（可配置中心点和半径、自动羽落效果）
- ✅ **传送付费系统**（所有传送类型独立收费配置、余额检查）
- ✅ **智能传送命令**（自动处理包含空格的玩家名）
- ✅ 商店系统（ushop、arc_button_shop集成）
- ✅ **股票系统**（up_and_down插件适配、股票市场入口）
- ✅ 公告系统（定时播放、动态占位符）
- ✅ 清道夫系统（定时清理掉落物）
- ✅ **新人欢迎系统**（自定义欢迎消息、自动执行指令）
- ✅ **OP状态追踪系统**（持久化OP状态、金钱排行榜隐藏）
- ✅ **数据库自动升级**（向后兼容、智能字段添加）
- ✅ 出生点保护系统
- ✅ OP 管理面板
- ✅ 多语言支持 (ZH-CN)
- ✅ 完整的 GUI 界面
- ✅ **经济系统 API** - 供其他插件调用的完整经济接口

### 计划中的功能
- 🔄 更多语言包支持
- 🔄 数据备份和恢复
- 🔄 领地系统 API 扩展
- 🔄 传送系统 API 扩展

---

*ARC Core 是一个功能完整、性能优异的 EndStone 插件，为服务器管理者提供了一站式的解决方案。*